services:
  redis:
    image: redis:7-alpine
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    depends_on:
      redis: { condition: service_healthy }
    environment:
      API_PORT: 3001
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      JWT_SECRET: ${JWT_SECRET}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      BOT_API_KEY: ${BOT_API_KEY}
      FRONTEND_URL: ${FRONTEND_URL}
    ports:
      # If 3001 is taken on the host, set API_PUBLIC_PORT in EasyPanel (e.g. 13001)
      - "${API_PUBLIC_PORT:-3001}:3001"

  worker:
    build:
      context: .
      dockerfile: apps/worker/Dockerfile
    depends_on:
      redis: { condition: service_healthy }
    environment:
      WORKER_HEALTH_PORT: 3030
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      WA_AUTH_ENC_KEY_B64: ${WA_AUTH_ENC_KEY_B64}
    # Optional: keep internal only. If you want to reach /health from outside, uncomment:
    # ports:
    #   - "3030:3030"
    expose:
      - "3030"

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL}
    environment:
      WEB_PORT: 3000
    ports:
      # If 3000 is taken on the host, set WEB_PUBLIC_PORT in EasyPanel (e.g. 13000)
      - "${WEB_PUBLIC_PORT:-3000}:3000"

